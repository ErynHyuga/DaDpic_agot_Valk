#Events managing health concerns

namespace = mz_health

## Lover's Pox Treatment Events
mz_health.2001 = { # Choose treatment
	type = character_event
	title = mz_health.2001.t
	desc = mz_health.2001.desc
	
	theme = healthcare
	left_portrait = {
		character = root
		animation = shame
	}
	right_portrait = { 
		character = scope:physician
		triggered_animation = {
			trigger = { scope:physician = { ai_rationality >= 0 } } #Don't look rational if you're not
			animation = personality_rational
		}
		animation = idle
	}

	trigger = { 
		court_physician_available_when_traveling_trigger = yes
		OR = {
			has_trait = lovers_pox 
			has_trait = early_great_pox
		}
	}

	immediate = {
		save_court_physician_as_effect = { SCOPE_NAME = physician }
	}

	option = { # Free treatment - no chance of removal, some chance of relief
		name = mz_health.2001.a
		mz_lovers_pox_free_treatment_effect = { TREATMENT_PICKER = ROOT PATIENT = ROOT }
		ai_chance = {
			base = 100
			modifier = { 
				scope:physician = { learning >= high_skill_rating }
				add = -90
			}
		}
	}

	option = { # Paid treatment - higher chance of relief, chance of critical success
		name = mz_health.2001.b
		remove_short_term_gold = minor_gold_value
		mz_lovers_pox_paid_treatment_effect = { TREATMENT_PICKER = ROOT PATIENT = ROOT }
		ai_chance = {
			base = 100
			modifier = { 
				scope:physician = { learning < high_skill_rating }
				add = -50
			}
			modifier = { 
				has_trait = greedy
				add = -50
			}
			modifier = { 
				short_term_gold < medium_gold_value
				add = -50
			}
		}
	}

	option = { # On second thought, no treatment - reset cooldown
		name = mz_health.2001.c
		remove_decision_cooldown = mz_lovers_pox_treatment_decision
		ai_chance = {
			base = 0
		}
	}
}

mz_health.2002 = { # Success (temporary relief) event
	type = character_event
	title = mz_health.2002.t
	desc = {
		random_valid = {
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.1.desc
			}
			triggered_desc = {
				trigger = { 
					NOT = { has_trait = temperate } 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.2.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.3.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.4.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.5.desc
			}
			triggered_desc = {
				trigger = { 
					ai_zeal > 0 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.6.desc
			}
			triggered_desc = {
				trigger = { 
					ai_zeal > 0 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.7.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.8.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.9.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.10.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.11.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.12.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.13.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.14.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.15.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.16.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.17.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.18.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:paid }
				desc = mz_health.2002.desc.paid
			}
			triggered_desc = { 
				trigger = { 
					NOT = { exists = scope:mz_treatment_type }
				}
				desc = mz_health.2002.desc.fallback
			}
		}
		desc = mz_health.2002.desc.end
	}
	
	theme = healthcare
	left_portrait = {
		character = root
		animation = happiness
	}
	override_background = { reference = bedchamber }

	trigger = { 
		court_physician_available_when_traveling_trigger = yes
		OR = {
			has_trait = lovers_pox 
			has_trait = early_great_pox
		}
	}

	immediate = {
		play_music_cue = "mx_cue_peace_ensues"
		recover_from_disease_effect = { DISEASE = lovers_pox } # It seems like health.2202 works on this despite a comment to the contrary, we'll see how it goes
		hidden_effect = {
			if = {
				limit = { scope:mz_treatment_type = flag:paid }
				random_list = {
					1 = {
						modifier = {
							exists = scope:physician
							scope:physician = { has_trait = lifestyle_physician }
							scope:physician = {
								has_trait_xp = {
									trait = lifestyle_physician
									value >= 100
								}
							}
							add = 1				
						}
						modifier = {
							exists = scope:physician
							scope:physician = { has_trait = lifestyle_physician }
							scope:physician = {
								has_trait_xp = {
									trait = lifestyle_physician
									value >= 50
								}
							}
							add = 1					
						}
						modifier = {
							exists = scope:physician
							scope:physician = { has_trait = lifestyle_physician }
							add = 1					
						}
						modifier = {
							health < 3 # No chance if in poor health or worse
							factor = 0
						}
						modifier = {
							health < 5 # Lower chance if not in at least good health
							factor = 0.5
						}
						modifier = {
							health >= 7 # Better chance if in excellent health
							factor = 2
						}
						# Liege Perk bonus
						modifier = {
							exists = scope:physician.liege
							scope:physician.liege = {
								has_perk = anatomical_studies_perk
							}
							add = 2
						}
						save_scope_value_as = {
							name = mz_pox_treatment_success
							value = flag:critical
						}
					}
					5 = {
						min = 1
						modifier = {
							exists = scope:physician
							add = {
								value = 0
								add = scope:physician.aptitude:court_physician_court_position
								multiply = -1
							}
						}
						save_scope_value_as = {
							name = mz_pox_treatment_success
							value = flag:normal
						}
					}
				}
			}
			else_if = {
				limit = { scope:mz_treatment_type = flag:free }
				save_scope_value_as = {
					name = mz_pox_treatment_success
					value = flag:normal
				}
			}	
			else = { # This shouldn't trigger
				save_scope_value_as = {
					name = mz_pox_treatment_success
					value = flag:normal
				}
			}
		}
	}

	option = {
		name = mz_health.2002.a
	}

	after = { # Trigger event later
		if = {
			limit = { scope:mz_pox_treatment_success = flag:normal }
			trigger_event = {
				id = mz_health.2010 #Pox returns
				days = 1095 # 3 years
			}
		}
		else_if = {
			limit = { scope:mz_pox_treatment_success = flag:critical }
			trigger_event = {
				id = mz_health.2011 #Pox cured
				days = 1095 # 3 years
			}
		}
	}
}

mz_health.2003 = { # Failure
	type = character_event
	title = mz_health.2003.t
	desc = {
		random_valid = {
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.1.desc
			}
			triggered_desc = {
				trigger = { 
					NOT = { has_trait = temperate } 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.2.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.3.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.4.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.5.desc
			}
			triggered_desc = {
				trigger = { 
					ai_zeal > 0 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.6.desc
			}
			triggered_desc = {
				trigger = { 
					ai_zeal > 0 
					scope:mz_treatment_type = flag:free
				}
				desc = health.safe_treatment.7.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.8.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.9.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.10.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.11.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.12.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.13.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.14.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.15.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.16.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.17.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:free }
				desc = health.safe_treatment.18.desc
			}
			triggered_desc = { 
				trigger = { scope:mz_treatment_type = flag:paid }
				desc = mz_health.2003.desc.paid
			}
			triggered_desc = { 
				trigger = { 
					NOT = { exists = scope:mz_treatment_type }
				}
				desc = mz_health.2003.desc.fallback
			}
		}
		desc = mz_health.2003.desc.end
	}
	theme = healthcare
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = { 
		character = scope:physician
		animation = shame
	}

	trigger = { 
		court_physician_available_when_traveling_trigger = yes
		OR = {
			has_trait = lovers_pox 
			has_trait = early_great_pox
		}
	}

	option = {
		name = mz_health.2003.a
	}
}

mz_health.2010 = { # Pox returns
	type = character_event
	title = mz_health.2010.t
	desc = mz_health.2010.desc
	
	theme = healthcare
	left_portrait = {
		character = root
		animation = shame
	}
	override_background = { reference = bedchamber }

	trigger = { 
		NOR = {
			has_trait = lovers_pox 
			has_trait = early_great_pox
		}
	}

	immediate = {
		if = {
			limit = { 
				has_character_flag = mz_removed_pox 
				NOT = { has_character_modifier = rejected_from_marriage_bed_modifier }
			}
			add_character_modifier = rejected_from_marriage_bed_modifier # If we removed this back when we cleared the pox, add it back in.
		}
		contract_disease_notify_effect = { DISEASE = lovers_pox }
	}

	option = { name = mz_health.2010.a }
}

mz_health.2011 = { # Pox cured
	type = character_event
	title = mz_health.2011.t
	desc = mz_health.2011.desc
	
	theme = healthcare
	left_portrait = {
		character = root
		animation = personality_bold
	}
	override_background = { reference = throne_room }

	immediate = { play_music_cue = "mx_cue_peace_ensues" }

	trigger = { 
		NOR = {
			has_trait = lovers_pox 
			has_trait = early_great_pox
		}
	}

	option = { name = mz_health.2011.a }
}